<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      /* === å…¨åŸŸè®Šæ•¸å®šç¾© === */
      :root {
        --bg-color: #ffffff;
        --text-color: #333333;
        --box-bg: #f9f9f9;
        --border-color: #ddd;
        --input-bg: #ffffff;
        --highlight-bg: #e3f2fd;
        --ai-border: #2196F3;
        --btn-primary: #007bff;
        --btn-ai: #9c27b0;
        --btn-disabled: #6c757d;
      }

      /* === æ·±è‰²æ¨¡å¼ === */
      @media (prefers-color-scheme: dark) {
        :root {
          --bg-color: #121212;
          --text-color: #f2f2f2;
          --box-bg: #1e1e1e;
          --border-color: #444;
          --input-bg: #2c2c2c;
          --highlight-bg: #1a3a5e;
        }
      }

      /* === åŸºç¤æ¨£å¼ === */
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 16px;
        font-size: 16px;
        line-height: 1.6;
        margin: auto;
        background-color: var(--bg-color);
        color: var(--text-color);
        max-width: 600px;
      }

      h2 {
        text-align: center;
        margin-bottom: 20px;
      }

      /* === è¼¸å…¥å…ƒä»¶æ¨£å¼ === */
      input[type="text"],
      input[type="password"],
      input[type="number"],
      input[type="file"],
      textarea {
        width: 100%;
        font-size: 16px;
        padding: 10px;
        box-sizing: border-box;
        margin-bottom: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
      }

      textarea {
        min-height: 120px;
        font-family: monospace;
      }

      /* === å€å¡Šå®¹å™¨ === */
      .box {
        border: 1px solid var(--border-color);
        padding: 16px;
        border-radius: 8px;
        background: var(--box-bg);
        margin-bottom: 20px;
      }

      .ai-box {
        background-color: var(--highlight-bg);
        border: 2px solid var(--ai-border);
      }

      /* === æŒ‰éˆ•æ¨£å¼ === */
      .btn {
        padding: 12px 20px;
        font-size: 16px;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        transition: opacity 0.3s;
        background: var(--btn-primary);
      }

      .btn-ai {
        background: var(--btn-ai);
        margin-top: 8px;
      }

      .btn:disabled {
        background: var(--btn-disabled);
        cursor: not-allowed;
        opacity: 0.7;
      }

      /* === è¼”åŠ©æ¨£å¼ === */
      .small-link {
        font-size: 0.85em;
        color: var(--btn-primary);
        text-decoration: none;
        display: inline-block;
        margin-bottom: 8px;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .hint-text {
        font-size: 0.85em;
        color: #888;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h2>ğŸ“¤ AI æ™ºæ…§å‡ºé¡Œç³»çµ±</h2>

    
    
    <div class="box ai-box">
      <strong>ğŸ¤– æ–¹å¼ä¸€ï¼šGemini AI è‡ªå‹•ç”Ÿæˆ JSON</strong><br>
      <div class="hint-text" style="margin-bottom: 10px;">
        æ²’æœ‰ API Keyï¼Ÿ
        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="small-link">
          ğŸ‘‰ å» Google AI Studio å…è²»ç”³è«‹
        </a>
      </div>
      
      <input type="password" id="apiKey" placeholder="åœ¨æ­¤è²¼ä¸Š Gemini API Key (ä»¥ AI... é–‹é ­)">
      
      <div style="margin-bottom: 12px;">
        <label style="font-size:0.9em; font-weight:bold;">ğŸ“š åƒè€ƒæ–‡ä»¶ (é¸å¡«)ï¼š</label>
        <input type="text" id="docUrl" placeholder="è«‹è²¼ä¸Š Google Docs æ–‡ä»¶ç¶²å€ (éœ€æœ‰æ¬Šé™)" style="margin-top:5px;">
        <div class="hint-text">â€» è‹¥å¡«å¯«æ­¤æ¬„ï¼ŒAI å°‡å„ªå…ˆæ ¹æ“šæ–‡ä»¶å…§å®¹å‡ºé¡Œã€‚è«‹ç¢ºä¿æ­¤ GAS å°ˆæ¡ˆåŸ·è¡Œè€…æœ‰æ¬Šé™è®€å–è©²æª”æ¡ˆã€‚</div>
      </div>

      <input type="text" id="topic" placeholder="è«‹è¼¸å…¥å‡ºé¡Œä¸»é¡Œ (ä¾‹å¦‚ï¼šå“¡å·¥å®ˆå‰‡ã€è³‡å®‰è¦ç¯„)">
      
      <div class="label-row">
        <span>é¡Œæ•¸ï¼š</span>
        <input type="number" id="qCount" value="5" min="1" max="20" style="width: 80px;">
      </div>

      <button id="aiBtn" class="btn btn-ai" onclick="generateByAI()">âœ¨ æ ¹æ“šæ–‡ä»¶/ä¸»é¡Œ ç”Ÿæˆé¡Œç›®</button>
    </div>

    <div class="box">
      <strong>ğŸ“ æ–¹å¼äºŒï¼šæ‰‹å‹•ä¸Šå‚³ï¼è²¼ä¸Š</strong><br>
      <div class="hint-text">AI ç”ŸæˆæˆåŠŸå¾Œï¼Œçµæœæœƒè‡ªå‹•å¡«å…¥ä¸‹æ–¹æ–‡å­—æ¡†ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹å‹•ä¿®æ”¹ã€‚</div>
      
      <input type="file" id="fileInput" accept=".json">
      <textarea id="jsonText" placeholder='åœ¨æ­¤è²¼ä¸Š JSONï¼Œæˆ–ç­‰å¾… AI ç”Ÿæˆ...'></textarea>
    </div>

    <label style="display:block; margin-bottom:15px; cursor:pointer;">
      <input type="checkbox" id="newMode" style="transform: scale(1.2);"> 
      å»ºç«‹æ–°çš„ Google Formï¼ˆä¸å‹¾é¸ï¼æ›´æ–°å›ºå®šè¡¨å–®ï¼‰
    </label>
    <input type="text" id="title" placeholder="è«‹è¼¸å…¥è©¦å·åç¨±ï¼ˆåƒ…é™æ–°å»ºæ™‚ï¼‰">

    <button id="submitBtn" class="btn" onclick="submitQuiz()">ğŸš€ å»ºç«‹ï¼æ›´æ–°è©¦å·</button>
    <div id="result" style="margin-top: 15px;"></div>

    <script>
      // === åŠŸèƒ½ A: AI ç”Ÿæˆé‚è¼¯ ===
      function generateByAI() {
        const apiKey  = document.getElementById('apiKey').value.trim();
        const topic   = document.getElementById('topic').value.trim();
        const count   = document.getElementById('qCount').value;
        const docUrl  = document.getElementById('docUrl').value.trim(); // é—œéµï¼šå–å¾—æ–‡ä»¶ç¶²å€

        const aiBtn   = document.getElementById('aiBtn');
        const jsonText= document.getElementById('jsonText');

        // é˜²å‘†æª¢æŸ¥
        if (!apiKey) {
          alert('âš ï¸ è«‹è¼¸å…¥ Gemini API Keyï¼');
          return;
        }
        if (!topic && !docUrl) {
          alert('âš ï¸ è«‹è‡³å°‘è¼¸å…¥ã€Œå‡ºé¡Œä¸»é¡Œã€æˆ–æ˜¯æä¾›ã€Œåƒè€ƒæ–‡ä»¶ç¶²å€ã€ï¼');
          return;
        }

        // é–å®šä»‹é¢
        aiBtn.disabled = true;
        aiBtn.innerText = 'â³ æ­£åœ¨é–±è®€æ–‡ä»¶ä¸¦å‡ºé¡Œä¸­...';
        jsonText.value = 'AI æ­£åœ¨åŠªåŠ›é–±è®€æ‚¨çš„æ–‡ä»¶ä¸¦ç”Ÿæˆé¡Œç›®ï¼Œè«‹ç¨å€™...';

        // å‘¼å«å¾Œç«¯ GAS
        google.script.run
          .withSuccessHandler((jsonResult) => {
            jsonText.value = jsonResult;
            aiBtn.disabled = false;
            aiBtn.innerText = 'âœ¨ æ ¹æ“šæ–‡ä»¶/ä¸»é¡Œ ç”Ÿæˆé¡Œç›®';
            alert('âœ… ç”ŸæˆæˆåŠŸï¼AI å·²æ ¹æ“šæ–‡ä»¶/ä¸»é¡Œå®Œæˆå‡ºé¡Œã€‚');
          })
          .withFailureHandler((err) => {
            jsonText.value = '';
            aiBtn.disabled = false;
            aiBtn.innerText = 'âœ¨ æ ¹æ“šæ–‡ä»¶/ä¸»é¡Œ ç”Ÿæˆé¡Œç›®';
            alert('âŒ ç”Ÿæˆå¤±æ•—ï¼š' + err.message);
          })
          .callGeminiToGenerateJson(apiKey, topic, count, docUrl);
      }

      // === åŠŸèƒ½ B: å»ºç«‹è©¦å·é‚è¼¯ ===
      function submitQuiz() {
        const titleInput = document.getElementById('title');
        const fileInput  = document.getElementById('fileInput');
        const txtInput   = document.getElementById('jsonText');
        const newModeEl  = document.getElementById('newMode');
        const resEl      = document.getElementById('result');
        const btn        = document.getElementById('submitBtn');

        const file  = fileInput.files[0];
        const txt   = txtInput.value.trim();
        const isNew = newModeEl.checked;
        const title = titleInput.value.trim() || 'è‡ªå‹•ç”¢ç”Ÿæ¸¬é©—';

        // å…§å®¹æª¢æŸ¥
        if (!file && !txt) {
          alert('âš ï¸ è«‹å…ˆé€é AI ç”Ÿæˆé¡Œç›®ï¼Œæˆ–æ˜¯æ‰‹å‹•è²¼ä¸Š JSON æ–‡å­—ï¼');
          txtInput.focus();
          return;
        }
        
        // æ ¼å¼é æª¢ (åƒ…é‡å°æ–‡å­—è¼¸å…¥)
        if (!file && txt) {
            try { JSON.parse(txt); } 
            catch(e) { 
                alert('âŒ JSON æ ¼å¼éŒ¯èª¤ï¼\nå¯èƒ½æ˜¯ AI ç”Ÿæˆäº†ä¸€åŠï¼Œæˆ–æ˜¯æ‰‹å‹•ä¿®æ”¹æ™‚å°‘äº†å¤§æ‹¬è™Ÿã€‚\nè«‹æª¢æŸ¥ä¸‹æ–¹æ–‡å­—æ¡†å…§å®¹ã€‚'); 
                return; 
            }
        }

        // UI é–å®š
        btn.disabled = true;
        btn.innerText = 'â³ è™•ç†ä¸­...';
        resEl.innerHTML = '';

        // å®šç¾©å¾Œç«¯å›èª¿è™•ç†
        const processPayload = (jsonString) => {
          const onSuccess = (resp) => {
             const info = JSON.parse(resp);
             resEl.innerHTML = `<div style="color:green">âœ… æˆåŠŸï¼<br><a href="${info.url}" target="_blank">ğŸ”— é–‹å•Ÿè¡¨å–®</a></div>`;
             resetBtn();
          };
          const onFailure = (err) => {
             resEl.innerHTML = `<div style="color:red">âŒ å¤±æ•—ï¼š${err.message}</div>`;
             resetBtn();
          };

          if (isNew) {
            google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).createQuizFromJson(jsonString, title);
          } else {
            google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).updateFixedQuiz(jsonString);
          }
        };

        // åˆ¤æ–·æ˜¯æª”æ¡ˆé‚„æ˜¯æ–‡å­—
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => processPayload(e.target.result);
          reader.readAsText(file);
        } else {
          processPayload(txt);
        }

        function resetBtn() {
          btn.disabled = false;
          btn.innerText = 'ğŸš€ å»ºç«‹ï¼æ›´æ–°è©¦å·';
        }
      }
    </script>
  </body>
</html>